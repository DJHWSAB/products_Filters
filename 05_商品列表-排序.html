<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <!-- æ ·å¼é‡ç½® -->
  <link rel="stylesheet" href="./css/rest.css">
  <!-- å…¬å…±æ ·å¼ -->
  <link rel="stylesheet" href="./css/common.css">
  <!-- å•†å“åˆ—è¡¨ -->
  <link rel="stylesheet" href="./css/product.css">
</head>

<body>
  <!-- ç‰ˆå¿ƒ -->
  <div class="wrapper">
    <!-- crumbs é¢åŒ…å±‘(å¯¼èˆª) -->
    <div class="crumbs">
      <span class="item">é¦–é¡µ</span>
      <span>&gt;</span>
      <span class="item">ç¬”è®°æœ¬</span>
    </div>

    <!-- å¯¹å†…å®¹è¿›è¡Œæ“ä½œ(operation) -->
    <div class="operation">
      <!-- åˆ†ç±» -->
      <ul class="row category">
        <li class="item">åˆ†ç±» ï¼š</li>
        <li class="item active">ç¬”è®°æœ¬</li>
        <li class="item">MateBook Eç³»åˆ—</li>
        <li class="item">MateBook Dç³»åˆ—</li>
        <li class="item">MateBook Xç³»åˆ—</li>
        <li class="item">åä¸ºæ˜¾ç¤ºå™¨ç³»åˆ—</li>
        <li class="item">MateBook Bç³»åˆ—</li>
        <li class="item nowrap_ellipsis">MateBookæ•°å­—ç³»åˆ—</li>
      </ul>
      <!-- ä¼˜æƒ  -->
      <ul class="row discount">
        <li class="item">æœåŠ¡ä¼˜æƒ  ï¼š</li>
        <li class="item">ä»…çœ‹æœ‰è´§</li>
        <li class="item">åˆ†æœŸå…æ¯</li>
        <li class="item">ä¼˜æƒ å•†å“</li>
      </ul>
      <!-- æ’åº -->
      <ul class="row sort">
        <li class="item">æ’åº ï¼š</li>
        <li data-key="default" class="item active">ç»¼åˆ</li>
        <li data-key="goodRate" class="item">å¥½è¯„</li>
        <li data-key="rateCount" class="item">è¯„è®ºæ•°</li>
        <li data-key="priceAccurate" class="item">ä»·æ ¼</li>
      </ul>
    </div>

    <!-- å•†å“åˆ—è¡¨éƒ¨åˆ† -->
    <ul class="products">
    </ul>
  </div>

  <script src="./json/product_data.js"></script>
  <script>
    // 0.èµ„æºæœåŠ¡å™¨çš„åœ°å€
    var serverURL = "https://res.vmallres.com/pimages"

    // 1.æœåŠ¡ä¼˜æƒ çš„ç­›é€‰
    var operationEl = document.querySelector(".operation")
    var discountEl = operationEl.querySelector(".discount")
    // 1.1è®°å½•ç”¨æˆ·é€‰ä¸­çš„æœåŠ¡ä¼˜æƒ 
    var discountFilters = []
    for (var i = 1; i < discountEl.children.length; i++) {
      // è·å–å¯¹åº”çš„discountItemEl
      var discountItemEl = discountEl.children[i]

      // ç›‘å¬discountItemElçš„ç‚¹å‡»
      discountItemEl.onclick = function () {
        // åœ¨ active å’Œ éactive åˆ‡æ¢
        this.classList.toggle("active")

        // åˆ¤æ–­æ˜¯å¦å°†å…³é”®å­—æ·»åŠ æˆ–è€…ä»discountFiltersåˆ é™¤æ‰
        if (this.classList.contains("active")) {
          discountFilters.push(this.textContent.trim())
        } else {
          var filterItemEl = this.textContent.trim()
          var filterIndex = discountFilters.findIndex(function (item) {
            return item === filterItemEl
          })
          discountFilters.splice(filterIndex, 1)
        }

        // è¿‡æ»¤filterResultListæ•°æ®
        filterResultListAction()
      }
    }

    // 1.2å°è£…å‡½æ•°: è¿‡æ»¤resultListæ•°æ®
    var showResultList = [...resultList]
    // var showResultList = [].concat(resultList)
    function filterResultListAction() {
      // 1.è¿‡æ»¤æ•°æ®
      showResultList = resultList.filter(function (item) {
        var services = item.services
        var isFlag = true
        for (var filterItem of discountFilters) {
          if (!services.includes(filterItem)) {
            isFlag = false
            break
          }
        }
        return isFlag
      })
      // 2.é‡æ–°å±•ç¤ºæ•°æ®
      sortResultListAction(true)
    }

    // 1.3å°è£…å‡½æ•°: å®ç°å¸ƒå±€å¯¹é½
    function layout() {
      // è·å–ul/liçš„å®½åº¦
      var ulWidth = productsEl.clientWidth
      var liWidth = productsEl.children[0].clientWidth
      // è·å–ä¸€è¡Œå­˜æ”¾å‡ ä¸ªli
      var count = Math.floor(ulWidth / liWidth)

      // æ·»åŠ spançš„ä¸ªæ•°æ˜¯åˆ—æ•°å‡-2 âœ…
      for (var i = 0; i < count - 2; i++) {
        var liEl = document.createElement("li")
        liEl.classList.add("item")
        liEl.style.height = "0"
        productsEl.append(liEl)
      }
    }

    // 2.ç›‘å¬æ’åºåŠŸèƒ½
    var sortEl = operationEl.querySelector(".sort")
    var activeEl = sortEl.querySelector(".active")
    // å…¨å±€ä¿å­˜sortKey
    var sortKey = "default"
    for (var i = 0; i < sortEl.children.length; i++) {
      var sortItemEl = sortEl.children[i]

      sortItemEl.onclick = function () {
        // 1.å–æ¶ˆä¹‹å‰çš„active,æ·»åŠ æ–°çš„active,è®°ä½æœ€æ–°çš„activeEl
        activeEl.classList.remove("active")
        this.classList.add("active")
        activeEl = this

        // 2.è·å–ä¿¡æ¯
        sortKey = this.dataset.key

        // 3.æ ¹æ®key,é€šè¿‡keyå¯¹æ•°æ®è¿›è¡Œæ’åº
        sortResultListAction(false)
      }
    }

    // å°è£…å‡½æ•°: å¯¹æ•°æ®è¿›è¡Œæ’åº
    function sortResultListAction(isJustShow) {
      if (sortKey === "default" && !isJustShow) {
        filterResultListAction()
      } else {
        showResultList.sort(function (item1, item2) {
          // ğŸ”¥ ä¸ºä»€ä¹ˆä¸æ˜¯item2.sortKey,å› ä¸ºkeyæ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²,æ‰€ä»¥è®¿é—®å¯¹è±¡å±æ€§,å¿…é¡»æ˜¯obj["xx"],è€Œä¸æ˜¯obj."xx"
          return item2[sortKey] - item1[sortKey]
        })
      }
      // æ•°æ®æ˜¾ç¤º
      showResultListAction()
    }


    // åŠ¨æ€çš„å±•ç¤ºå•†å“åˆ—è¡¨
    var productsEl = document.querySelector(".products")
    showResultListAction()
    // 1.4å°è£…å‡½æ•°: é€šè¿‡forå¾ªç¯,å±•ç¤ºæ•°æ®
    function showResultListAction() {
      // é˜²æ­¢å‡ºç°å åŠ æƒ…å†µ
      productsEl.innerHTML = ""

      for (var i = 0; i < showResultList.length; i++) {
        // 2.1 è·å–ä¸€æ¡æ•°æ®
        var resultItem = showResultList[i]

        // 2.2 å°†è¿™æ¡æ•°æ®è½¬æ¢æˆç•Œé¢ä¸€ä¸ªitem

        // 1)åˆ›å»ºliå…ƒç´ 
        var itemEl = document.createElement("li")
        itemEl.classList.add("item")
        productsEl.append(itemEl)

        // æ ‡ç­¾
        var tagString = ""
        // åˆ¤æ–­æ˜¯å¦æœ‰è¿™ä¸ªæ ‡ç­¾,å¦‚æœæœ‰å°±åˆ›å»º
        if (resultItem.tag) {
          tagString = `<i class="tag">${resultItem.tag}</i>`
        }

        // æœåŠ¡
        var serviceString = ""

        // ğŸšš æ–¹æ³•ä¸€: for
        // for (var j = 0; j < resultItem.promoLabels.length; j++) {
        //   serviceString += `<span class="tip">${resultItem.promoLabels[j]}</span>`
        // }

        // ğŸšš æ–¹æ³•äºŒ: for...of
        for (var label of resultItem.promoLabels) {
          serviceString += `<span class="tip">${label}</span>`
        }


        // ä»·æ ¼
        var priceString = "";
        // ğŸšš æ–¹æ³•ä¸€: for
        // for (var key in resultItem.price) {
        //   var value = resultItem.price[key];
        //   if (key === "newPrice") {
        //     priceString += "<span class='new-price'>Â¥" + value + "</span>";
        //   } else if (key === "oldPrice") {
        //     priceString += "<span class='old-price'>Â¥" + value + "</span>";
        //   }
        // }

        // ğŸšš æ–¹æ³•äºŒ: for...in
        for (var key in resultItem.price) {
          var value = resultItem.price[key]
          if (key === "newPrice") {
            priceString += "<span class='new-price'>Â¥" + value + "</span>";
          } else if (key === "oldPrice") {
            priceString += "<span class='old-price'>Â¥" + value + "</span>";
          }
        }
        // itemElé‡Œé¢çš„å†…å®¹
        itemEl.innerHTML = `
        <a href="#">
          <!-- å°é¢ -->
          <img class="album" src="${serverURL}${resultItem.photoPath}800_800_${resultItem.photoName}" alt="">
          <!-- åå­— -->
          <div class="name">
            ${tagString}
            <span class="title nowrap_ellipsis">${resultItem.name}</span>
          </div>
          <!-- æè¿° -->
          <div class="describe nowrap_ellipsis">${resultItem.promotionInfo}</div>
          <!-- æœåŠ¡ -->
          <div class="service">${serviceString}</div>
          <!-- ä»·æ ¼ -->
          <div class="price">${priceString}</div>
          <!-- è¯„è®º -->
          <div class="comment">
            <span>${resultItem.rateCount}äººè¯„ä»·</span>
            <span>${resultItem.goodRate}%å¥½è¯„</span>
          </div>
        </a>
      `
      }

      // å¸ƒå±€å¯¹é½
      layout()
    }
  </script>
</body>

</html>